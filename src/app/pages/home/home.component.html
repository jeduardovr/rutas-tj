<div class="app-container">

    <header class="mobile-header">
        <h1 class="brand-title">
            <img src="/images/logo.png" alt="Logo" class="brand-logo"> Rutas Tijuana
        </h1>
        <button (click)="toggleSidebar()" class="menu-btn">
            <i class="fas fa-bars"></i>
        </button>
    </header>

    <aside class="sidebar" [class.open]="isSidebarOpen()">

        <nav class="nav-rail">
            <div class="nav-brand-icon">
                <img src="/images/logo.png" alt="Logo" class="nav-logo">
            </div>

            <div class="nav-items">
                <button class="nav-item" [class.active]="viewMode() === 'viewer'" (click)="setViewMode('viewer')"
                    title="Ver Rutas">
                    <div class="nav-icon"><i class="fas fa-map-marked-alt"></i></div>
                    <span class="nav-label">Rutas</span>
                </button>

                <button class="nav-item" [class.active]="viewMode() === 'creator'" (click)="setViewMode('creator')"
                    title="Crear Nueva Ruta">
                    <div class="nav-icon"><i class="fas fa-pen-nib"></i></div>
                    <span class="nav-label">Crear</span>
                </button>
            </div>

            <div class="nav-footer">
                <small>v1.0</small>
            </div>
        </nav>

        <div class="panel-content">

            @if (viewMode() === 'viewer') {
            <div class="panel-view fade-in">
                <div class="panel-header">
                    <h2>Rutas Tijuana</h2>
                    <p>Transporte Público</p>
                </div>

                <div class="search-container">
                    <div class="search-wrapper">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" placeholder="Buscar destino..." class="search-input"
                            (input)="filterRoutes($event)" />
                    </div>
                </div>

                <div class="routes-list">
                    @if (isLoading()) {
                    <div class="loading-state">
                        <i class="fas fa-spinner fa-spin loading-icon"></i>
                        <p>Cargando rutas...</p>
                    </div>
                    } @else {
                    @for (route of filteredRoutes(); track route._id || route.id) {
                    <div (click)="selectRoute(route)" class="route-card"
                        [class.active]="(selectedRoute()?._id || selectedRoute()?.id) === (route._id || route.id)"
                        [style.border-left-color]="route.color">
                        <div class="route-content">
                            <div class="route-header">
                                <h3 class="route-name">{{ route.name }}</h3>
                                <span class="route-type">{{ route.type }}</span>
                            </div>
                            <div class="landmarks-container">
                                @for (mark of route.landmarks.slice(0, 3); track mark) {
                                <span class="landmark-tag">{{ mark }}</span>
                                }
                            </div>
                        </div>
                    </div>
                    } @empty {
                    <div class="empty-state">
                        <i class="fas fa-route empty-icon"></i>
                        <p>No encontramos rutas con ese nombre.</p>
                    </div>
                    }
                    }
                </div>
            </div>
            }

            @if (viewMode() === 'creator') {
            <div class="panel-view fade-in">
                <div class="panel-header creator-bg">
                    @if (isEditing()) {
                    <h2>Editar Ruta: {{ newRoute.name || 'Sin Nombre' }}</h2>
                    <p>Modifica el formulario o el trazado.</p>
                    } @else {
                    <h2>Crear Nueva Ruta</h2>
                    <p>Traza la ruta en el mapa</p>
                    }
                </div>

                <div class="form-scroll-area">
                    <div class="form-container">
                        <div class="form-group">
                            <label>Nombre</label>
                            <input type="text" [(ngModel)]="newRoute.name" placeholder="Ej. Rojo y Negro"
                                class="form-input">
                        </div>

                        <div class="form-row">
                            <div class="form-group half">
                                <label>Tipo</label>
                                <select [(ngModel)]="newRoute.type" class="form-input">
                                    <option value="taxi">Taxi</option>
                                    <option value="bus">Autobús</option>
                                    <option value="calafia">Calafia</option>
                                </select>
                            </div>
                            <div class="form-group half">
                                <label>Color</label>
                                <div class="color-picker-wrapper">
                                    <input type="color" [(ngModel)]="newRoute.color"
                                        (change)="updateCreatorPolylineStyle()" class="color-input">
                                    <span class="color-value">{{newRoute.color}}</span>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Descripción</label>
                            <textarea [(ngModel)]="newRoute.description" rows="2" class="form-input"></textarea>
                        </div>

                        <div class="form-group">
                            <label>Puntos Clave (CSV)</label>
                            <input type="text" [(ngModel)]="landmarksString" placeholder="Centro, 5y10..."
                                class="form-input">
                        </div>

                        <div class="creator-stats">
                            <div class="stat">
                                <span class="stat-val">{{ getPathLength() }}</span>
                                <span class="stat-label">Puntos</span>
                            </div>
                            <div class="stat-actions">
                                <button (click)="undoLastPoint()" class="btn-icon" title="Deshacer">
                                    <i class="fas fa-undo"></i>
                                </button>
                                <button (click)="clearCreatorMap()" class="btn-icon danger" title="Borrar todo">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>

                        <button (click)="saveNewRoute()" class="btn-primary full-width">
                            <i class="fas fa-save"></i>
                            @if (isEditing()) {
                            Guardar Cambios
                            } @else {
                            Guardar Nueva Ruta
                            }
                        </button>

                        <div class="instruction-text">
                            <small><i class="fas fa-mouse-pointer"></i> Clic en mapa para trazar.</small>
                        </div>
                    </div>
                </div>
            </div>
            }
        </div>
    </aside>

    @if (isSidebarOpen()) {
    <div class="overlay" (click)="toggleSidebar()"></div>
    }

    <main class="main-content">
        <div id="map-viewer" class="map-container" [class.hidden]="viewMode() !== 'viewer'"></div>

        <div id="map-creator" class="map-container" [class.hidden]="viewMode() !== 'creator'"></div>

        @if (viewMode() === 'viewer' && selectedRoute()) {
        <div class="info-card" [style.border-color]="selectedRoute()?.color">
            <div class="info-header">
                <div>
                    <span class="info-subtitle">Ruta Seleccionada</span>
                    <h2 class="info-title">{{ selectedRoute()?.name }}</h2>
                </div>
                <div class="info-actions">
                    <button (click)="startEditing(selectedRoute()!)" class="btn-icon" title="Editar Ruta">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button (click)="clearSelection()" class="close-btn"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <p class="info-description">{{ selectedRoute()?.description }}</p>
            <div class="info-landmarks">
                <div class="tags-wrapper">
                    @for (mark of selectedRoute()?.landmarks; track mark) { <span class="tag">{{ mark }}</span> }
                </div>
            </div>
        </div>
        }
    </main>
</div>