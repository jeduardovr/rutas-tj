<div class="app-container">

    <header class="mobile-header">
        <h1 class="brand-title">
            <img src="/images/logo.png" alt="Logo" class="brand-logo"> Rutas Tijuana
        </h1>
        <button (click)="toggleSidebar()" class="menu-btn">
            <i class="fas fa-bars"></i>
        </button>
    </header>

    <aside class="sidebar" [class.open]="isSidebarOpen()">

        <nav class="nav-rail">
            <div class="nav-brand-icon">
                <img src="/images/logo.png" alt="Logo" class="nav-logo">
            </div>

            <div class="nav-items">
                <button class="nav-item" [class.active]="viewMode() === 'viewer'" (click)="setViewMode('viewer')"
                    title="Ver Rutas">
                    <div class="nav-icon"><i class="fas fa-map-marked-alt"></i></div>
                    <span class="nav-label">Rutas</span>
                </button>

                @if (authService.isLoggedIn()) {
                <button class="nav-item" [class.active]="viewMode() === 'creator'"
                    (click)="overrideSetViewMode('creator')" title="Crear Nueva Ruta">
                    <div class="nav-icon"><i class="fas fa-pen-nib"></i></div>
                    <span class="nav-label">Crear</span>
                </button>
                }

                @if (authService.isLoggedIn() && authService.hasAccessToRoute('/admin-proposals')) {
                <button class="nav-item" (click)="goToAdminProposals()" title="Administrar Propuestas">
                    <div class="nav-icon"><i class="fas fa-tasks"></i></div>
                    <span class="nav-label">Solicitud</span>
                </button>
                }
            </div>

            <div class="nav-footer">
                @if (!authService.isLoggedIn()) {
                <button class="btn-login styled-login" (click)="goToLogin()" title="Iniciar sesión">
                    <i class="fas fa-sign-in-alt"></i>
                </button>
                } @else {
                }
                <small class="version-text">v1.0</small>
            </div>
        </nav>

        <div class="panel-content">
            @if (viewMode() === 'viewer') {
            <div class="panel-view fade-in">
                <div class="panel-header">
                    <h2>Explorar Rutas</h2>
                    <p>Transporte Público en Tijuana</p>
                </div>

                <div class="search-container">
                    <div class="search-wrapper">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" placeholder="¿A dónde quieres ir?" class="search-input"
                            (input)="filterRoutes($event)" />
                    </div>
                    <button class="btn-location" [class.active]="sortByProximity()" (click)="toggleSortByProximity()"
                        [disabled]="isLoadingLocation()"
                        title="{{ sortByProximity() ? 'Desactivar ordenamiento por cercanía' : 'Ordenar por cercanía' }}">
                        @if (isLoadingLocation()) {
                        <i class="fas fa-circle-notch fa-spin"></i>
                        } @else {
                        <i class="fas fa-location-arrow"></i>
                        }
                    </button>
                </div>

                <div class="routes-list">
                    @if (isLoading()) {
                    <div class="loading-state">
                        <i class="fas fa-circle-notch fa-spin loading-icon"></i>
                        <p>Cargando rutas...</p>
                    </div>
                    } @else {
                    @for (route of filteredRoutes(); track route._id || route.id) {
                    <div (click)="selectRoute(route)" class="route-card"
                        [class.active]="(selectedRoute()?._id || selectedRoute()?.id) === (route._id || route.id)">

                        <div class="route-color-strip" [style.background-color]="route.color"></div>

                        <div class="route-content">
                            <div class="route-header">
                                <div class="route-title-group">
                                    <h3 class="route-name">{{ route.from }} - {{ route.to }}</h3>
                                    <span class="route-type-badge" [class]="route.type.toLowerCase()">
                                        @if(route.type.toLowerCase() === 'taxi') { <i class="fas fa-taxi"></i> }
                                        @if(route.type.toLowerCase() === 'bus') { <i class="fas fa-bus"></i> }
                                        @if(route.type.toLowerCase() === 'calafia') { <i class="fas fa-shuttle-van"></i>
                                        }
                                        {{ route.type }}
                                    </span>
                                </div>
                            </div>

                            <p class="route-desc-preview">{{ route.description || 'Ruta sin descripción detallada.' }}
                            </p>

                            @if (route.schedule && (route.schedule.start || route.schedule.end)) {
                            <div class="route-schedule">
                                <i class="fas fa-clock"></i>
                                <span>{{ route.schedule.start || '--' }} - {{ route.schedule.end || '--' }}</span>
                            </div>
                            }
                        </div>

                        <div class="route-action">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                    } @empty {
                    <div class="empty-state">
                        <i class="fas fa-search-location empty-icon"></i>
                        <p>No encontramos rutas con ese criterio.</p>
                    </div>
                    }
                    }
                </div>
            </div>
            }

            <app-create-route style="overflow-y: auto;" *ngIf="viewMode() === 'creator'" [newRoute]="newRoute"
                [isEditing]="isEditing()" [is24Hours]="is24Hours" [landmarksString]="landmarksString"
                [pathLength]="getPathLength()" (saveRoute)="saveNewRoute()" (cancel)="onCancelCreateRoute()"
                (undoPoint)="undoLastPoint()" (removePoint)="removeCreatorPoint($event)" (clearMap)="clearCreatorMap()"
                (updateColor)="updateCreatorPolylineStyle()"></app-create-route>
        </div>
    </aside>

    @if (isSidebarOpen()) {
    <div class="overlay" (click)="toggleSidebar()"></div>
    }

    <main class="main-content">
        @if (authService.isLoggedIn()) {
        <div class="map-user-control fade-in">
            <div class="user-capsule-float">
                <div class="user-avatar-float" title="{{ authService.currentUser()?.name }}">
                    {{ authService.currentUser()?.name?.charAt(0)?.toUpperCase() || 'U' }}
                </div>
                <div class="user-details-float">
                    <span class="user-name-float">{{ authService.currentUser()?.name }}</span>
                    <span class="user-role-float">{{ authService.getRoleName() || 'Usuario' }}</span>
                </div>
            </div>

            <!-- Botones de Acción flotantes (separados de la capsula para limpieza) -->
            @if (authService.hasAccessToRoute('/admin-proposals')) {
            <button class="btn-admin-proposals" (click)="goToAdminProposals()" title="Administrar Propuestas">
                <i class="fas fa-tasks"></i>
            </button>
            }
            <button class="btn-map-logout" (click)="logout()" title="Cerrar Sesión">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </div>
        }

        <div id="map-viewer" class="map-container" [class.hidden]="viewMode() !== 'viewer'"></div>

        <div id="map-creator" class="map-container" [class.hidden]="viewMode() !== 'creator'"></div>

        @if (viewMode() === 'viewer' && selectedRoute()) {
        <div class="info-card fade-in" [class.collapsed]="isCardCollapsed()">
            <!-- Handle for mobile -->
            <div class="card-handle" (click)="toggleCardState()"></div>

            <div class="info-color-top" [style.background-color]="selectedRoute()?.color"></div>

            <div class="info-body">
                <div class="info-header">
                    <div>
                        <span class="info-subtitle">{{ selectedRoute()?.type }}</span>
                        <h2 class="info-title">{{ selectedRoute()?.from }} - {{ selectedRoute()?.to }}</h2>
                    </div>
                    <div class="info-actions">
                        @if (authService.hasAccessToRoute('/admin-proposals')) {
                        <button (click)="deleteSelectedRoute()" class="btn-icon-sm close" title="Eliminar ruta">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                        }
                        <button (click)="overrideStartEditing(selectedRoute()!)" class="btn-icon-sm"
                            title="Editar esta ruta">
                            <i class="fas fa-pencil-alt"></i>
                        </button>
                        <button (click)="clearSelection()" class="btn-icon-sm close" title="Cerrar">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>

                <p class="info-description">{{ selectedRoute()?.description || 'Sin descripción disponible.' }}</p>

                @if (selectedRoute()?.schedule && (selectedRoute()?.schedule?.start || selectedRoute()?.schedule?.end))
                {
                <div class="info-schedule">
                    <i class="fas fa-clock"></i>
                    <span>Horario: {{ selectedRoute()?.schedule?.start || '--' }} - {{ selectedRoute()?.schedule?.end ||
                        '--' }}</span>
                </div>
                }

                <div class="info-landmarks">
                    <img [src]="getImage(selectedRoute()!)" alt="Imagen de la ruta"
                        style="width: 100%; height: auto; border-radius: 8px;">
                </div>
            </div>
        </div>
        }
        <div class="ad-container fade-in" *ngIf="viewMode() === 'viewer'">
            <div class="ad-card">
                <span class="ad-label">Publicidad</span>
                <img src="https://placehold.co/300x100/3b82f6/white?text=Espacio+Publicitario" alt="Publicidad"
                    class="ad-image">
                <button class="ad-close-btn" title="Cerrar publicidad">&times;</button>
            </div>
        </div>
    </main>
</div>