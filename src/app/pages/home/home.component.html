<div class="app-container">

    <header class="mobile-header">
        <h1 class="brand-title">
            <img src="/images/logo.png" alt="Logo" class="brand-logo"> Rutas Tijuana
        </h1>
        <button (click)="toggleSidebar()" class="menu-btn">
            <i class="fas fa-bars"></i>
        </button>
    </header>

    <aside class="sidebar" [class.open]="isSidebarOpen()">

        <nav class="nav-rail">
            <div class="nav-brand-icon">
                <img src="/images/logo.png" alt="Logo" class="nav-logo">
            </div>

            <div class="nav-items">
                <button class="nav-item" [class.active]="viewMode() === 'viewer'" (click)="setViewMode('viewer')"
                    title="Ver Rutas">
                    <div class="nav-icon"><i class="fas fa-map-marked-alt"></i></div>
                    <span class="nav-label">Rutas</span>
                </button>

                @if (authService.isLoggedIn()) {
                <button class="nav-item" [class.active]="viewMode() === 'creator'"
                    (click)="overrideSetViewMode('creator')" title="Crear Nueva Ruta">
                    <div class="nav-icon"><i class="fas fa-pen-nib"></i></div>
                    <span class="nav-label">Crear</span>
                </button>
                }
            </div>

            <div class="nav-footer">
                @if (!authService.isLoggedIn()) {
                <button class="btn-login styled-login" (click)="goToLogin()" title="Iniciar sesión">
                    <i class="fas fa-sign-in-alt"></i>
                </button>
                } @else {
                }
                <small class="version-text">v1.0</small>
            </div>
        </nav>
        
        <div class="panel-content">
            @if (viewMode() === 'viewer') {
            <div class="panel-view fade-in">
                <div class="panel-header">
                    <h2>Explorar Rutas</h2>
                    <p>Transporte Público en Tijuana</p>
                </div>

                <div class="search-container">
                    <div class="search-wrapper">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" placeholder="¿A dónde quieres ir?" class="search-input"
                            (input)="filterRoutes($event)" />
                    </div>
                </div>

                <div class="routes-list">
                    @if (isLoading()) {
                    <div class="loading-state">
                        <i class="fas fa-circle-notch fa-spin loading-icon"></i>
                        <p>Cargando rutas...</p>
                    </div>
                    } @else {
                    @for (route of filteredRoutes(); track route._id || route.id) {
                    <div (click)="selectRoute(route)" class="route-card"
                        [class.active]="(selectedRoute()?._id || selectedRoute()?.id) === (route._id || route.id)">

                        <div class="route-color-strip" [style.background-color]="route.color"></div>

                        <div class="route-content">
                            <div class="route-header">
                                <div class="route-title-group">
                                    <h3 class="route-name">{{ route.from }} - {{ route.to }}</h3>
                                    <span class="route-type-badge" [class]="route.type.toLowerCase()">
                                        @if(route.type.toLowerCase() === 'taxi') { <i class="fas fa-taxi"></i> }
                                        @if(route.type.toLowerCase() === 'bus') { <i class="fas fa-bus"></i> }
                                        @if(route.type.toLowerCase() === 'calafia') { <i class="fas fa-shuttle-van"></i>
                                        }
                                        {{ route.type }}
                                    </span>
                                </div>
                            </div>

                            <p class="route-desc-preview">{{ route.description || 'Ruta sin descripción detallada.' }}
                            </p>

                            @if (route.schedule && (route.schedule.start || route.schedule.end)) {
                            <div class="route-schedule">
                                <i class="fas fa-clock"></i>
                                <span>{{ route.schedule.start || '--' }} - {{ route.schedule.end || '--' }}</span>
                            </div>
                            }

                            <div class="landmarks-container">
                                <i class="fas fa-map-marker-alt text-muted"></i>
                                <div class="landmarks-scroll">
                                    @for (mark of route.landmarks.slice(0, 3); track mark) {
                                    <span class="landmark-tag">{{ mark }}</span>
                                    }
                                </div>
                            </div>
                        </div>

                        <div class="route-action">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                    } @empty {
                    <div class="empty-state">
                        <i class="fas fa-search-location empty-icon"></i>
                        <p>No encontramos rutas con ese criterio.</p>
                    </div>
                    }
                    }
                </div>
            </div>
            }

                        <app-create-route
                        style="overflow-y: auto;"
                            *ngIf="viewMode() === 'creator'"
                            [newRoute]="newRoute"
                            [isEditing]="isEditing()"
                            [is24Hours]="is24Hours"
                            [landmarksString]="landmarksString"
                            [pathLength]="getPathLength()"
                            (saveRoute)="saveNewRoute()"
                            (cancel)="onCancelCreateRoute()"
                            (undoPoint)="undoLastPoint()"    
                            (clearMap)="clearCreatorMap()"    
                            (updateColor)="updateCreatorPolylineStyle()" 
                        ></app-create-route>
        </div>
    </aside>

    @if (isSidebarOpen()) {
    <div class="overlay" (click)="toggleSidebar()"></div>
    }

    <main class="main-content">
        @if (authService.isLoggedIn()) {
        <div class="map-user-control fade-in">
            <div class="user-avatar" title="{{ authService.currentUser()?.name }}">
                {{ authService.currentUser()?.name?.charAt(0) || 'U' }}
            </div>
            <button class="btn-map-logout" (click)="logout()" title="Cerrar Sesión">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </div>
        }

        <div id="map-viewer" class="map-container" [class.hidden]="viewMode() !== 'viewer'"></div>

        <div id="map-creator" class="map-container" [class.hidden]="viewMode() !== 'creator'"></div>

        @if (viewMode() === 'viewer' && selectedRoute()) {
        <div class="info-card fade-in">
            <div class="info-color-top" [style.background-color]="selectedRoute()?.color"></div>

            <div class="info-body">
                <div class="info-header">
                    <div>
                        <span class="info-subtitle">{{ selectedRoute()?.type }}</span>
                        <h2 class="info-title">{{ selectedRoute()?.from }} - {{ selectedRoute()?.to }}</h2>
                    </div>
                    <div class="info-actions">
                        <button (click)="overrideStartEditing(selectedRoute()!)" class="btn-icon-sm"
                            title="Editar esta ruta">
                            <i class="fas fa-pencil-alt"></i>
                        </button>
                        <button (click)="clearSelection()" class="btn-icon-sm close" title="Cerrar">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>

                <p class="info-description">{{ selectedRoute()?.description || 'Sin descripción disponible.' }}</p>

                @if (selectedRoute()?.schedule && (selectedRoute()?.schedule?.start || selectedRoute()?.schedule?.end))
                {
                <div class="info-schedule">
                    <i class="fas fa-clock"></i>
                    <span>Horario: {{ selectedRoute()?.schedule?.start || '--' }} - {{ selectedRoute()?.schedule?.end ||
                        '--' }}</span>
                </div>
                }

                <div class="info-landmarks">
                    <span class="info-label"><i class="fas fa-map-signs"></i> Puntos Clave:</span>
                    <div class="tags-wrapper">
                        @for (mark of selectedRoute()?.landmarks; track mark) {
                        <span class="tag">{{ mark }}</span>
                        }
                    </div>
                </div>
            </div>
        </div>
        }
    </main>
</div>